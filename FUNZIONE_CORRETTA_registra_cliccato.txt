    def _registra_cliccato(self, e):
        username = self.txt_reg_username.value.strip()
        email = self.txt_reg_email.value.lower().strip()
        nome = self.txt_reg_nome.value.strip()
        cognome = self.txt_reg_cognome.value.strip()
        password = self.txt_reg_password.value
        conferma_password = self.txt_reg_conferma_password.value
        data_nascita = self.txt_reg_data_nascita.value.strip()
        codice_fiscale = self.txt_reg_codice_fiscale.value.strip()
        indirizzo = self.txt_reg_indirizzo.value.strip()

        # Reset errori
        for field in [self.txt_reg_username, self.txt_reg_email, self.txt_reg_nome, self.txt_reg_cognome,
                      self.txt_reg_password, self.txt_reg_conferma_password,
                      self.txt_reg_data_nascita, self.txt_reg_codice_fiscale, self.txt_reg_indirizzo]:
            field.error_text = None

        # Validazione
        is_valid = True
        if not all([username, email, nome, cognome, password, conferma_password, data_nascita, codice_fiscale, indirizzo]):
            self.controller.show_snack_bar("Tutti i campi sono obbligatori.", success=False)
            is_valid = False
        if password != conferma_password:
            self.txt_reg_conferma_password.error_text = "Le password non coincidono."
            is_valid = False

        if not is_valid:
            self.page.update()
            return

        result = registra_utente(nome, cognome, username, password, email, data_nascita, codice_fiscale, indirizzo)

        if result:
            id_nuovo_utente = result.get("id_utente")
            recovery_key = result.get("recovery_key")
            
            invito_attivo = self.page.session.get("invito_attivo")
            if invito_attivo:
                aggiungi_utente_a_famiglia(invito_attivo['id_famiglia'], id_nuovo_utente,
                                           invito_attivo['ruolo_assegnato'])
                self.page.session.remove("invito_attivo")

            # Show recovery key dialog
            def close_dialog(e):
                dialog.open = False
                self.page.update()
                self.page.go("/")
            
            dialog = ft.AlertDialog(
                modal=True,
                title=ft.Text("SALVA LA TUA CHIAVE DI RECUPERO", weight=ft.FontWeight.BOLD),
                content=ft.Column([
                    ft.Text("Questa e' la tua chiave di recupero. SALVALA IN UN POSTO SICURO!", size=14),
                    ft.Text("Se perdi la password, questa chiave e' l'UNICO modo per recuperare i tuoi dati.", 
                           size=12, color=ft.Colors.RED_400),
                    ft.Container(height=10),
                    ft.TextField(
                        value=recovery_key,
                        read_only=True,
                        multiline=True,
                        text_size=12,
                        border_color=ft.Colors.BLUE_400
                    ),
                    ft.Container(height=10),
                    ft.Text("Senza questa chiave, i dati criptati saranno PERSI per sempre!", 
                           size=11, italic=True, color=ft.Colors.ORANGE_400)
                ], tight=True, scroll=ft.ScrollMode.AUTO),
                actions=[
                    ft.TextButton("Ho salvato la chiave", on_click=close_dialog)
                ],
                actions_alignment=ft.MainAxisAlignment.END
            )
            
            self.page.overlay.append(dialog)
            dialog.open = True
            self.page.update()
        else:
            self.txt_reg_username.error_text = "Username o Email gia' in uso."
            self.page.update()
